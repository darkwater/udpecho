name: Build and Package

on:
  push:
  workflow_dispatch:

jobs:
  linux-build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - arch: amd64
            target: x86_64-unknown-linux-gnu
            deb_arch: amd64
          - arch: arm64
            target: aarch64-unknown-linux-gnu
            deb_arch: arm64
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install cross-compilation tools
        if: matrix.arch == 'arm64'
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu

      - name: Install cargo-deb
        run: cargo install cargo-deb --locked

      - name: Build release binary
        run: |
          if [ "${{ matrix.arch }}" = "arm64" ]; then
            export CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER=aarch64-linux-gnu-gcc
          fi
          cargo build --release --target ${{ matrix.target }}

      - name: Build Debian package
        run: cargo deb --no-build --target ${{ matrix.target }}

      - name: Upload binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: udpecho-linux-${{ matrix.arch }}
          path: target/${{ matrix.target }}/release/udpecho

      - name: Upload Debian package
        uses: actions/upload-artifact@v4
        with:
          name: udpecho-debian-package-${{ matrix.arch }}
          path: target/${{ matrix.target }}/debian/*.deb

  integration-test-amd64:
    runs-on: ubuntu-latest
    needs: linux-build
    steps:
      - name: Download Debian package
        uses: actions/download-artifact@v4
        with:
          name: udpecho-debian-package-amd64

      - name: Install package
        run: |
          sudo apt-get update
          sudo apt-get install -y ./udpecho_*.deb

      - name: Create test secret file
        run: echo "test-secret-123" | sudo tee /tmp/test-secret

      - name: Configure service
        run: |
          sudo mkdir -p /etc/default
          echo "BIND_ADDR=127.0.0.1:19999" | sudo tee /etc/default/udpecho
          echo "SECRET_FILE=/tmp/test-secret" | sudo tee -a /etc/default/udpecho

      - name: Start service
        run: |
          sudo systemctl daemon-reload
          sudo systemctl restart udpecho
          sleep 2
          sudo systemctl status udpecho

      - name: Test UDP echo service
        run: |
          # Send the correct secret and expect it back
          echo -n "test-secret-123" | nc -u -w 1 127.0.0.1 19999 > /tmp/response.txt
          
          # Check if response matches
          if grep -q "test-secret-123" /tmp/response.txt; then
            echo "✓ Service responded correctly to valid secret"
          else
            echo "✗ Service did not respond correctly"
            exit 1
          fi
          
          # Send wrong secret and expect no response (timeout)
          if timeout 2 bash -c 'echo -n "wrong-secret" | nc -u -w 1 127.0.0.1 19999' > /tmp/response2.txt 2>&1; then
            echo "✗ Service should not respond to wrong secret"
            exit 1
          else
            echo "✓ Service correctly ignored wrong secret"
          fi

  integration-test-arm64:
    runs-on: ubuntu-latest
    needs: linux-build
    steps:
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Download Debian package
        uses: actions/download-artifact@v4
        with:
          name: udpecho-debian-package-arm64

      - name: Test in arm64 container
        run: |
          # Run integration test in arm64 Debian container
          docker run --rm --platform linux/arm64 \
            -v $(pwd):/workspace \
            -w /workspace \
            debian:bookworm-slim \
            bash -c '
              set -e
              apt-get update
              apt-get install -y systemd netcat-openbsd ./udpecho_*.deb
              
              # Create test secret
              echo "test-secret-123" > /tmp/test-secret
              
              # Configure environment
              mkdir -p /etc/default
              echo "BIND_ADDR=127.0.0.1:19999" > /etc/default/udpecho
              echo "SECRET_FILE=/tmp/test-secret" >> /etc/default/udpecho
              
              # Start service in background (systemd not available in container)
              BIND_ADDR=127.0.0.1:19999 SECRET_FILE=/tmp/test-secret /usr/bin/udpecho &
              SERVICE_PID=$!
              sleep 2
              
              # Test with correct secret
              echo -n "test-secret-123" | nc -u -w 1 127.0.0.1 19999 > /tmp/response.txt || true
              if grep -q "test-secret-123" /tmp/response.txt; then
                echo "✓ ARM64: Service responded correctly to valid secret"
              else
                echo "✗ ARM64: Service did not respond correctly"
                kill $SERVICE_PID
                exit 1
              fi
              
              # Test with wrong secret (should timeout/no response)
              if timeout 2 bash -c "echo -n \"wrong-secret\" | nc -u -w 1 127.0.0.1 19999" > /tmp/response2.txt 2>&1; then
                echo "✗ ARM64: Service should not respond to wrong secret"
                kill $SERVICE_PID
                exit 1
              else
                echo "✓ ARM64: Service correctly ignored wrong secret"
              fi
              
              kill $SERVICE_PID
              echo "✓ All ARM64 integration tests passed"
            '
