name: Build and Package

on:
  push:
  workflow_dispatch:

jobs:
  linux-build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - arch: amd64
            target: x86_64-unknown-linux-gnu
            deb_arch: amd64
          - arch: arm64
            target: aarch64-unknown-linux-gnu
            deb_arch: arm64
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install cross-compilation tools
        if: matrix.arch == 'arm64'
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu

      - name: Install cargo-deb
        run: cargo install cargo-deb --locked

      - name: Build release binary
        run: |
          if [ "${{ matrix.arch }}" = "arm64" ]; then
            export CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER=aarch64-linux-gnu-gcc
          fi
          cargo build --release --target ${{ matrix.target }}

      - name: Build Debian package
        run: cargo deb --no-build --target ${{ matrix.target }}

      - name: Upload binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: udpecho-linux-${{ matrix.arch }}
          path: target/${{ matrix.target }}/release/udpecho

      - name: Upload Debian package
        uses: actions/upload-artifact@v4
        with:
          name: udpecho-debian-package-${{ matrix.arch }}
          path: target/${{ matrix.target }}/debian/*.deb

  integration-test-amd64:
    runs-on: ubuntu-latest
    needs: linux-build
    steps:
      - name: Download Debian package
        uses: actions/download-artifact@v4
        with:
          name: udpecho-debian-package-amd64

      - name: Install package
        run: |
          sudo apt-get update
          sudo apt-get install -y ./udpecho_*.deb

      - name: Create test secret file
        run: echo "test-secret-123" | sudo tee /tmp/test-secret

      - name: Configure service
        run: |
          sudo mkdir -p /etc/default
          echo "BIND_ADDR=127.0.0.1:19999" | sudo tee /etc/default/udpecho
          echo "SECRET_FILE=/tmp/test-secret" | sudo tee -a /etc/default/udpecho

      - name: Start service
        run: |
          sudo systemctl daemon-reload
          sudo systemctl restart udpecho
          sleep 2
          sudo systemctl status udpecho

      - name: Test UDP echo service
        run: |
          # Install netcat if not available
          sudo apt-get install -y netcat-openbsd
          
          # Send the correct secret and expect it back
          response=$(echo -n "test-secret-123" | nc -u -w 1 127.0.0.1 19999)
          
          # Check if response matches
          if [ "$response" = "test-secret-123" ]; then
            echo "✓ Service responded correctly to valid secret"
          else
            echo "✗ Service did not respond correctly"
            echo "Expected: test-secret-123"
            echo "Got: $response"
            exit 1
          fi
          
          # Send wrong secret and expect no response (should timeout)
          set +e
          response2=$(timeout 2 bash -c 'echo -n "wrong-secret" | nc -u -w 1 127.0.0.1 19999')
          exit_code=$?
          set -e
          
          if [ -n "$response2" ]; then
            echo "✗ Service should not respond to wrong secret"
            echo "Got unexpected response: $response2"
            exit 1
          else
            echo "✓ Service correctly ignored wrong secret"
          fi

  integration-test-arm64:
    runs-on: ubuntu-latest
    needs: linux-build
    steps:
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Download Debian package
        uses: actions/download-artifact@v4
        with:
          name: udpecho-debian-package-arm64

      - name: Test in arm64 container
        run: |
          cat > test-arm64.sh << 'EOF'
          #!/bin/bash
          set -e
          
          # Cleanup function
          cleanup() {
            if [ -n "$SERVICE_PID" ] && kill -0 $SERVICE_PID 2>/dev/null; then
              kill $SERVICE_PID
            fi
          }
          trap cleanup EXIT
          
          apt-get update -qq
          apt-get install -y netcat-openbsd ./udpecho_*.deb
          
          # Create test secret
          echo "test-secret-123" > /tmp/test-secret
          
          # Start service in background (systemd not available in container)
          BIND_ADDR=127.0.0.1:19999 SECRET_FILE=/tmp/test-secret /usr/bin/udpecho &
          SERVICE_PID=$!
          sleep 2
          
          # Test with correct secret
          response=$(echo -n "test-secret-123" | nc -u -w 1 127.0.0.1 19999 || true)
          if [ "$response" = "test-secret-123" ]; then
            echo "✓ ARM64: Service responded correctly to valid secret"
          else
            echo "✗ ARM64: Service did not respond correctly"
            echo "Expected: test-secret-123"
            echo "Got: $response"
            exit 1
          fi
          
          # Test with wrong secret (should timeout/no response)
          response2=$(timeout 2 bash -c 'echo -n "wrong-secret" | nc -u -w 1 127.0.0.1 19999' || true)
          if [ -n "$response2" ]; then
            echo "✗ ARM64: Service should not respond to wrong secret"
            echo "Got unexpected response: $response2"
            exit 1
          else
            echo "✓ ARM64: Service correctly ignored wrong secret"
          fi
          
          echo "✓ All ARM64 integration tests passed"
          EOF
          
          chmod +x test-arm64.sh
          
          # Run test in arm64 container
          docker run --rm --platform linux/arm64 \
            -v $(pwd):/workspace \
            -w /workspace \
            debian:bookworm-slim \
            bash /workspace/test-arm64.sh
