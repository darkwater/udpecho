name: Build and Package

on:
  push:
  workflow_dispatch:

jobs:
  build-and-test:
    runs-on: ${{ matrix.runner }}
    permissions:
      contents: read
    strategy:
      matrix:
        include:
          - arch: amd64
            runner: ubuntu-latest
          - arch: arm64
            runner: ubuntu-24.04-arm
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-deb
        run: cargo install cargo-deb --locked

      - name: Build release binary
        run: cargo build --release

      - name: Build Debian package
        run: cargo deb --no-build

      - name: Upload binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: udpecho-linux-${{ matrix.arch }}
          path: target/release/udpecho

      - name: Upload Debian package
        uses: actions/upload-artifact@v4
        with:
          name: udpecho-debian-package-${{ matrix.arch }}
          path: target/debian/*.deb

      - name: Install package
        run: |
          sudo apt-get update
          sudo apt-get install -y ./target/debian/*.deb

      - name: Create test secret file
        run: |
          echo "test-secret-123" | sudo tee /tmp/test-secret
          sudo chmod 640 /tmp/test-secret
          sudo chown udpecho:udpecho /tmp/test-secret

      - name: Configure service
        run: |
          sudo mkdir -p /etc/default
          echo "BIND_ADDR=127.0.0.1:19999" | sudo tee /etc/default/udpecho
          echo "SECRET_FILE=/tmp/test-secret" | sudo tee -a /etc/default/udpecho

      - name: Start service
        run: |
          sudo systemctl daemon-reload
          
          # Try to restart service and capture any error
          if ! sudo systemctl restart udpecho 2>&1 | tee /tmp/systemctl.log; then
            echo "‚ùå systemctl restart failed with output:"
            cat /tmp/systemctl.log
          fi
          
          sleep 2
          
          # Check service status and show detailed logs on failure
          if ! sudo systemctl is-active --quiet udpecho; then
            echo "‚ùå Service failed to start. Status:"
            sudo systemctl status udpecho --no-pager || true
            echo ""
            echo "üìã Service logs:"
            sudo journalctl -u udpecho -n 50 --no-pager || true
            echo ""
            echo "üîç Binary check:"
            ls -la /usr/bin/udpecho || echo "Binary not found"
            echo ""
            echo "üë§ User check:"
            id udpecho || echo "User not found"
            echo ""
            echo "üìÅ Secret file check:"
            ls -la /tmp/test-secret || echo "Secret file not found"
            echo ""
            echo "üì¶ Package contents check:"
            dpkg -L udpecho | grep bin || echo "No binaries in package"
            exit 1
          fi
          
          echo "‚úì Service started successfully"
          sudo systemctl status udpecho --no-pager

      - name: Test UDP echo service
        run: |
          # Install socat for reliable UDP testing
          sudo apt-get install -y socat
          
          # Send the correct secret (with newline) and expect it back
          # Note: echo adds a newline, matching the default /etc/hostname behavior
          response=$(echo "test-secret-123" | socat - UDP:127.0.0.1:19999,shut-none)
          
          # Check if response matches
          if [ "$response" = "test-secret-123" ]; then
            echo "‚úì Service responded correctly to valid secret"
          else
            echo "‚úó Service did not respond correctly"
            echo "Expected: test-secret-123"
            echo "Got: $response"
            exit 1
          fi
          
          # Send wrong secret and expect no response (should timeout)
          set +e
          response2=$(timeout 2 bash -c 'echo "wrong-secret" | socat - UDP:127.0.0.1:19999,shut-none')
          exit_code=$?
          set -e
          
          if [ -n "$response2" ]; then
            echo "‚úó Service should not respond to wrong secret"
            echo "Got unexpected response: $response2"
            exit 1
          else
            echo "‚úì Service correctly ignored wrong secret"
          fi
          
          echo "‚úì All tests passed for ${{ matrix.arch }}"

  release:
    if: startsWith(github.ref, 'refs/tags/')
    needs: build-and-test
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release assets
        run: |
          mkdir -p release-assets
          
          # Copy and rename binaries
          cp artifacts/udpecho-linux-amd64/udpecho release-assets/udpecho-linux-amd64
          cp artifacts/udpecho-linux-arm64/udpecho release-assets/udpecho-linux-arm64
          
          # Copy debian packages with proper naming
          cp artifacts/udpecho-debian-package-amd64/*.deb release-assets/
          cp artifacts/udpecho-debian-package-arm64/*.deb release-assets/
          
          # List all files for verification
          ls -lh release-assets/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: release-assets/*
          draft: false
          prerelease: false
          generate_release_notes: true
