name: Build and Package

on:
  push:
  workflow_dispatch:

jobs:
  linux-build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - arch: amd64
            target: x86_64-unknown-linux-gnu
            deb_arch: amd64
          - arch: arm64
            target: aarch64-unknown-linux-gnu
            deb_arch: arm64
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install cross-compilation tools
        if: matrix.arch == 'arm64'
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu

      - name: Install cargo-deb
        run: cargo install cargo-deb --locked

      - name: Build release binary
        run: |
          if [ "${{ matrix.arch }}" = "arm64" ]; then
            export CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER=aarch64-linux-gnu-gcc
          fi
          cargo build --release --target ${{ matrix.target }}

      - name: Build Debian package
        run: cargo deb --no-build --target ${{ matrix.target }}

      - name: Upload binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: udpecho-linux-${{ matrix.arch }}
          path: target/${{ matrix.target }}/release/udpecho

      - name: Upload Debian package
        uses: actions/upload-artifact@v4
        with:
          name: udpecho-debian-package-${{ matrix.arch }}
          path: target/${{ matrix.target }}/debian/*.deb

  integration-test-amd64:
    runs-on: ubuntu-latest
    needs: linux-build
    permissions:
      contents: read
    steps:
      - name: Download Debian package
        uses: actions/download-artifact@v4
        with:
          name: udpecho-debian-package-amd64

      - name: Install package
        run: |
          sudo apt-get update
          sudo apt-get install -y ./udpecho_*.deb

      - name: Create test secret file
        run: |
          echo "test-secret-123" | sudo tee /tmp/test-secret
          sudo chmod 644 /tmp/test-secret
          sudo chown udpecho:udpecho /tmp/test-secret || true

      - name: Configure service
        run: |
          sudo mkdir -p /etc/default
          echo "BIND_ADDR=127.0.0.1:19999" | sudo tee /etc/default/udpecho
          echo "SECRET_FILE=/tmp/test-secret" | sudo tee -a /etc/default/udpecho

      - name: Start service
        run: |
          sudo systemctl daemon-reload
          sudo systemctl restart udpecho || true
          sleep 2
          
          # Check service status and show detailed logs on failure
          if ! sudo systemctl is-active --quiet udpecho; then
            echo "‚ùå Service failed to start. Status:"
            sudo systemctl status udpecho --no-pager || true
            echo ""
            echo "üìã Service logs:"
            sudo journalctl -u udpecho -n 50 --no-pager || true
            echo ""
            echo "üîç Binary check:"
            ls -la /usr/bin/udpecho || echo "Binary not found"
            echo ""
            echo "üë§ User check:"
            id udpecho || echo "User not found"
            echo ""
            echo "üìÅ Secret file check:"
            ls -la /tmp/test-secret || echo "Secret file not found"
            exit 1
          fi
          
          echo "‚úì Service started successfully"
          sudo systemctl status udpecho --no-pager

      - name: Test UDP echo service
        run: |
          # Install netcat if not available
          sudo apt-get install -y netcat-openbsd
          
          # Send the correct secret and expect it back
          response=$(echo -n "test-secret-123" | nc -u -w 1 127.0.0.1 19999)
          
          # Check if response matches
          if [ "$response" = "test-secret-123" ]; then
            echo "‚úì Service responded correctly to valid secret"
          else
            echo "‚úó Service did not respond correctly"
            echo "Expected: test-secret-123"
            echo "Got: $response"
            exit 1
          fi
          
          # Send wrong secret and expect no response (should timeout)
          set +e
          response2=$(timeout 2 bash -c 'echo -n "wrong-secret" | nc -u -w 1 127.0.0.1 19999')
          exit_code=$?
          set -e
          
          if [ -n "$response2" ]; then
            echo "‚úó Service should not respond to wrong secret"
            echo "Got unexpected response: $response2"
            exit 1
          else
            echo "‚úì Service correctly ignored wrong secret"
          fi

  integration-test-arm64:
    runs-on: ubuntu-latest
    needs: linux-build
    permissions:
      contents: read
    steps:
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Download Debian package
        uses: actions/download-artifact@v4
        with:
          name: udpecho-debian-package-arm64

      - name: Test in arm64 container
        run: |
          cat > test-arm64.sh << 'EOF'
          #!/bin/bash
          set -e
          
          # Update package lists
          apt-get update -qq
          
          # Install required packages
          apt-get install -y netcat-openbsd systemd ./udpecho_*.deb
          
          # Create test secret with proper permissions
          echo "test-secret-123" > /tmp/test-secret
          chmod 644 /tmp/test-secret
          chown udpecho:udpecho /tmp/test-secret
          
          # Configure service
          mkdir -p /etc/default
          echo "BIND_ADDR=127.0.0.1:19999" > /etc/default/udpecho
          echo "SECRET_FILE=/tmp/test-secret" >> /etc/default/udpecho
          
          # Start systemd service (running directly since systemd daemon not available)
          # We'll run the service as the udpecho user to match production
          echo "Starting service as udpecho user..."
          su -s /bin/bash udpecho -c 'BIND_ADDR=127.0.0.1:19999 SECRET_FILE=/tmp/test-secret /usr/bin/udpecho' &
          SERVICE_PID=$!
          
          # Cleanup function
          cleanup() {
            if [ -n "$SERVICE_PID" ] && kill -0 $SERVICE_PID 2>/dev/null; then
              kill $SERVICE_PID
            fi
          }
          trap cleanup EXIT
          
          sleep 2
          
          # Verify service is running
          if ! kill -0 $SERVICE_PID 2>/dev/null; then
            echo "‚úó ARM64: Service failed to start"
            exit 1
          fi
          
          # Test with correct secret
          response=$(echo -n "test-secret-123" | nc -u -w 1 127.0.0.1 19999 || true)
          if [ "$response" = "test-secret-123" ]; then
            echo "‚úì ARM64: Service responded correctly to valid secret"
          else
            echo "‚úó ARM64: Service did not respond correctly"
            echo "Expected: test-secret-123"
            echo "Got: $response"
            
            # Debug information
            echo "üîç Binary check:"
            ls -la /usr/bin/udpecho || echo "Binary not found"
            echo "üìÅ Secret file check:"
            ls -la /tmp/test-secret || echo "Secret file not found"
            
            exit 1
          fi
          
          # Test with wrong secret (should timeout/no response)
          response2=$(timeout 2 bash -c 'echo -n "wrong-secret" | nc -u -w 1 127.0.0.1 19999' || true)
          if [ -n "$response2" ]; then
            echo "‚úó ARM64: Service should not respond to wrong secret"
            echo "Got unexpected response: $response2"
            exit 1
          else
            echo "‚úì ARM64: Service correctly ignored wrong secret"
          fi
          
          echo "‚úì All ARM64 integration tests passed"
          EOF
          
          chmod +x test-arm64.sh
          
          # Run test in arm64 container with privileged mode for systemd
          docker run --rm --platform linux/arm64 \
            --privileged \
            -v $(pwd):/workspace \
            -w /workspace \
            debian:bookworm-slim \
            bash /workspace/test-arm64.sh
